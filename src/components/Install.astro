---
const { downloadUrlMac, downloadUrlWindows, downloadUrlLinux, gamePathTitle } = Astro.props;
---
<script>
    import { download } from '@tauri-apps/plugin-upload';
    import { load } from '@tauri-apps/plugin-store';
    import { type } from '@tauri-apps/plugin-os';
    import { Command } from '@tauri-apps/plugin-shell';

    const store = await load('presto-data.json', { autoSave: true });
    const currentSettings = await store.get<{ value: string }>('settings');
    // Detect OS
    console.log(currentSettings);
    const currentPlatform = type();
    console.log("currentPlatform", currentPlatform);
    const downloadFile = {
        'macos': 'downloadUrlMac',
        'windows': 'downloadUrlWindows', 
        'linux': 'downloadUrlLinux'
    }[currentPlatform];

    const installButton = document.querySelector("button.install");
    if(installButton != null) {
        installButton.addEventListener("click", async () => {
            if (currentSettings && currentSettings.installPath) {
                globalThis.presto.functions.showDownloadBar(true);
                let progressTotal = 0;
                const zipPath = `${currentSettings.installPath}/${installButton.dataset.gamePathTitle}.zip`;
                const extractPath = `${currentSettings.installPath}/${installButton.dataset.gamePathTitle}`;
                const tempPath = `${currentSettings.installPath}/temp`;

                try {
                    if (currentPlatform === 'windows') {
                        // Check if directory exists first
                        const checkResult = await Command.create('exec-win-powershell', [
                            'Test-Path',
                            '-Path', tempPath
                        ]).execute();
                        
                        if (checkResult.stdout.trim() === 'True') {
                            await Command.create('exec-win-powershell', [
                                'Remove-Item',
                                '-Path', tempPath,
                                '-Recurse',
                                '-Force'
                            ]).execute();
                        }
                    } else {
                        // macOS and Linux both use test -d for directory check
                        const checkResult = await Command.create('exec-nix-unzip', [
                            'test',
                            '-d',
                            tempPath
                        ]).execute();
                        
                        if (checkResult.code === 0) {
                            await Command.create('exec-nix-unzip', [
                                'rm',
                                '-rf',
                                tempPath
                            ]).execute();
                        }
                    }
                } catch (e) {
                    console.log("Error checking/removing temp directory:", e);
                }
                
                await download(
                    installButton.dataset[downloadFile],
                    zipPath,
                    ({progress, total}) => {
                        console.log(`Downloaded ${progress} of ${total} bytes`);
                        progressTotal = progress;
                        globalThis.presto.functions.updateProgress(installButton.dataset.gamePathTitle + '.zip', (progressTotal / total) * 100);
                    },
                ).finally(async () => {
                    // Extract based on platform
                    let result;
                    if (currentPlatform === 'windows') {
                        result = await new Command('exec-win-powershell', [
                            'Expand-Archive',
                            '-Path', zipPath,
                            '-DestinationPath', extractPath,
                            '-Force'
                        ]).execute();
                    } else {
                        // macOS and Linux both use unzip
                        result = await new Command('exec-nix-unzip', [
                            '-o', zipPath,
                            '-d', extractPath
                        ]).execute();
                    }
                    console.log("zipPath", zipPath);
                    console.log("extractPath", extractPath);
                    console.log("result", result);
                    globalThis.presto.functions.showDownloadBar(false);
                });
            }
        });
    }
</script>
<button class="btn install" 
data-game-path-title={gamePathTitle} 
data-download-url-mac={downloadUrlMac}
data-download-url-windows={downloadUrlWindows}
data-download-url-linux={downloadUrlLinux}>
Install</button>